{{ define "exchanges" }}
<div>
    <h1>{{.Title}}</h1>
    <div class="container"> 
        <table>
            <thead>
                <tr>
                    <th>Virtual Host</th>
                    <th>Name</th>
                    <th>Type</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody id="exchanges-list">
                <!-- Exchanges will be populated here -->
            </tbody>
        </table>
    </div>
    <div class="container">        
        <p>Add a new exchange</p>
        <form id="add-exchange-form">
            <input type="text" id="exchange-name" placeholder="Exchange Name" required>
            <button type="submit">Add Exchange</button>
        </form>
    </div>
    <div class="container" id="bindings-manager" style="display: none;">
        <p>Bindings</p>
        <table>
            <thead>
                <tr>
                    <th>Routing Key</th>
                    <th>Queue</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody id="bindings-list">
                <!-- Bindings will be populated here -->
            </tbody>
        </table>
        <form id="add-binding-form">
            <input type="hidden" id="selected-exchange">
            <input type="text" id="routing-key" placeholder="Routing Key" required>
            <input type="text" id="queue-name" placeholder="Queue Name" required>
            <button type="submit">Add Binding</button>
        </form>
    </div>
    <div class="container" id="publish-message" style="display: none;">
        <p>Publish Message</p>
        <form id="publish-message-form">
            <input type="hidden" id="selected-exchange-for-message">
            <input type="text" id="msg-routing-key" placeholder="Routing Key" required>
            <input type="text" id="payload" placeholder="Message" required>
            <button type="submit">Publish</button>
        </form>
    </div>
</div>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        fetchExchanges();

        document.getElementById('add-exchange-form').addEventListener('submit', function(e) {
            e.preventDefault();
            const exchangeName = document.getElementById('exchange-name').value;
            addExchange(exchangeName);
        });

        document.getElementById('add-binding-form').addEventListener('submit', function(e) {
            e.preventDefault();
            const exchange = document.getElementById('selected-exchange').value;
            const routingKey = document.getElementById('routing-key').value;
            const queue = document.getElementById('queue-name').value;
            addBinding(exchange, routingKey, queue);
        });

        document.getElementById('publish-message-form').addEventListener('submit', function(e) {
            e.preventDefault();
            const exchange = document.getElementById('selected-exchange-for-message').value;
            const routingKey = document.getElementById('msg-routing-key').value;
            const message = document.getElementById('payload').value;
            publishMessage(exchange, routingKey, message);
        });
    });

    async function fetchExchanges() {
        const response = await fetch('/api/exchanges');
        const data = await response.json();
        const exchangesList = document.getElementById('exchanges-list');
        exchangesList.innerHTML = '';
        data.exchanges.forEach(exchange => {
            const row = document.createElement('tr');
            row.onclick = () => selectExchange(exchange);
            row.innerHTML = `
                <td>localhost</td>
                <td><b>${exchange}<b></td>
                <td>direct</td>
                <td>
                    <button onclick="deleteExchange('${exchange}')">Delete</button>
                </td>
            `;
            exchangesList.appendChild(row);
        });
    }

    async function addExchange(name) {
        const response = await fetch('/api/exchanges', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({name})
        });
        if (response.ok) fetchExchanges();
    }

    async function deleteExchange(name) {
        const response = await fetch(`/api/exchanges/${name}`, { method: 'DELETE' });
        if (response.ok) fetchExchanges();
    }

    async function fetchBindings(exchange) {
        const response = await fetch(`/api/bindings/${exchange}`);
        const data = await response.json();
        const bindingsList = document.getElementById('bindings-list');
        bindingsList.innerHTML = '';
        Object.entries(data.bindings).forEach(([routingKey, queues]) => {
            queues.forEach(queue => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${routingKey}</td>
                    <td>${queue}</td>
                    <td>
                        <button onclick="deleteBinding('${exchange}', '${routingKey}', '${queue}')">Unbind</button>
                    </td>
                `;
                bindingsList.appendChild(row);
            });
        });
    }

    async function addBinding(exchange, routingKey, queue) {
        const response = await fetch('/api/bindings', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({exchange_name: exchange, routing_key: routingKey, queue_name: queue})
        });
        if (response.ok) fetchBindings(exchange);
    }

    async function deleteBinding(exchange, routingKey, queue) {
        const response = await fetch('/api/bindings', {
            method: 'DELETE',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({exchange_name: exchange, routing_key: routingKey, queue_name: queue})
        });
        if (response.ok) fetchBindings(exchange);
    }

    async function publishMessage(exchange, routingKey, message) {
        const response = await fetch('/api/messages', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({exchange_name: exchange, routing_key: routingKey, message})
        });
        if (response.ok) alert('Message published successfully!');
    }

    function selectExchange(exchange) {
        document.getElementById('selected-exchange').value = exchange;
        document.getElementById('selected-exchange-for-message').value = exchange;
        document.getElementById('bindings-manager').style.display = 'block';
        document.getElementById('publish-message').style.display = 'block';
        fetchBindings(exchange);
    }
</script>
{{ end }}
